#!/usr/bin/env bash

set -euxo pipefail

pushd "$HOME/dotfiles/" && ./up && popd

if command -v yay &> /dev/null; then
    yay
elif command -v yum &> /dev/null; then
    sudo yum check-update
    sudo yum update
elif command -v nixos-rebuild &> /dev/null; then
    echo "FIGURE OUT FLAKES WITH NIXOS"
    # sudo nixos-rebuild switch --upgrade
elif command -v apt-get &> /dev/null; then
    sudo apt-get update
    sudo apt-get dist-upgrade
fi

if command -v nix &> /dev/null; then
    pushd  "$HOME/dotfiles" && nix flake update && popd
fi

if command -v home-manager &> /dev/null; then
    home-manager --flake "$HOME/dotfiles" switch
fi

if command -v fwupdmgr &> /dev/null; then
    if fwupdmgr refresh; then
        if fwupdmgr get-updates; then
            fwupdmgr update
        fi
    fi
fi

if command -v rustup &> /dev/null; then
    rustup update
    if command -v nix-shell &> /dev/null; then
        nix-shell -p openssl pkg-config udev --run "cargo install-update -a || true"
    else
        cargo install-update -a || true
    fi
fi

if test -f "$HOME/dotfiles/hosts/$(hostname)/up"; then
    "$HOME/dotfiles/hosts/$(hostname)/up"
fi

if command -v imdb-rename; then
    imdb-rename --update-data
fi

if [[ -v DISPLAY ]]; then
    fixkb
fi

