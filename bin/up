#!/usr/bin/env bash

set -euxo pipefail

pushd "$HOME/dotfiles/" && ./up && popd

if command -v nix &> /dev/null; then
    nix flake update "$HOME/dotfiles"
fi

if command -v yay &> /dev/null; then
    yay
elif command -v yum &> /dev/null; then
    sudo yum check-update
    sudo yum update
elif command -v nixos-rebuild &> /dev/null; then
    # TODO: Make pure.
    sudo nixos-rebuild --flake "$HOME/dotfiles" switch --impure
elif command -v apt-get &> /dev/null; then
    sudo apt-get update
    sudo apt-get dist-upgrade
fi

if command -v home-manager &> /dev/null; then
    home-manager --flake "$HOME/dotfiles" switch
fi

if command -v fwupdmgr &> /dev/null; then
    if fwupdmgr refresh; then
        if fwupdmgr get-updates; then
            fwupdmgr update
        fi
    fi
fi

if command -v rustup &> /dev/null; then
    rustup update
fi

if test -f "$HOME/dotfiles/hosts/$(hostname)/up"; then
    "$HOME/dotfiles/hosts/$(hostname)/up"
fi

if [[ -v DISPLAY ]]; then
    fixkb
fi

