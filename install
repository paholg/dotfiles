#!/usr/bin/env bash
set -euxo pipefail

function check_continue {
    read -rp "$1 (y/N) " yn
    if [ "$yn" != "y" ]; then
        exit 1
    fi
}

check_continue "Replace .git/hooks/pre-commit?"
ln -sf ../../pre-commit .git/hooks/pre-commit

if test -f "$(hostname)/configuration.nix"; then
    check_continue "Replace /etc/nixos/configuration.nix?"

    sudo ln -sf "$HOME/dotfiles/$(hostname)/configuration.nix /etc/nixos/configuration.nix"

    check_continue "Switch to NixOs unstable?"
    sudo nix-channel --add https://nixos.org/channels/nixos-unstable nixos
    sudo nixos-rebuild switch --upgrade
else
    echo "Not on NixOs!"
    echo "You may need to install nscd"
    echo "See: https://github.com/NixOS/nixpkgs/issues/12335#issuecomment-212325290"
    nix-channel --add https://nixos.org/channels/nixpkgs-unstable nixpkgs
fi

if test -f "$(hostname)/home.nix"; then
    check_continue "Replace $HOME/.config/home-manager/home.nix?"

    mkdir -p "$HOME/.config/home-manager"
    ln -sf "$HOME/dotfiles/$(hostname)/home.nix" "$HOME/.config/home-manager/home.nix"
    
    nix-channel --add https://github.com/nix-community/home-manager/archive/master.tar.gz home-manager
    nix-channel --update

    echo "Installing. You may need to log out first on NixOs, or add a thing elsewhere."
    echo "See https://github.com/rycee/home-manager#installation"

    # For non-NixOs
    # DO I STILL NEED THIS???
    # export NIX_PATH=$HOME/.nix-defexpr/channels:/nix/var/nix/profiles/per-user/root/channels${NIX_PATH:+:$NIX_PATH}

    nix-shell '<home-manager>' -A install
fi

if test -f "$(hostname)/install"; then
    echo "Running hostname-specific install"

    . "$(hostname)/install"
fi
